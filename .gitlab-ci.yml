variables:
  MAVEN_OPTS: "-Djava.awt.headless=true -Dmaven.repo.local=./.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  ACCESS_KEY: "$AWS_ACCESS_KEY_ID"
  SECRET_KEY: "$AWS_SECRET_ACCESS_KEY"
  REGION: "AWS_DEFAULT_REGION"
  S3_BUCKET: "$AWS_S3_BUCKET"
  JAR_NAME: "city-api-0.0.1-SNAPSHOT.jar"

cache:
  paths:
    - ./.m2/repository
  # keep cache across branch
  key: "$CI_BUILD_REF_NAME"

stages:          # List of stages for jobs, and their order of execution
  - build
  - test
  - copy-to-s3
  - deploy

build-job:       # This job runs in the build stage, which runs first.
  stage: build
  script:
    - echo "Compiling the code..."
    - "mvn clean compile $MAVEN_CLI_OPTS"
    - echo "Compile complete."
  artifacts:
    paths:
      - target/

unittest-job:
  stage: test
  dependencies:
    - build-job
  script:
    - echo "Running unit tests of the City API Application..."
    - "mvn verify $MAVEN_CLI_OPTS"
    - echo "Completed Unit Tests of the City API Application."
  artifacts:
    paths:
      - target/

integrationtest-job:
  stage: test
  dependencies:
    - unittest-job
  script:
    - echo "Running Integration Tests of the City API Application..."
    - "mvn package $MAVEN_CLI_OPTS"
    - echo "Complete Integration Tests of the City API Application..."
  artifacts:
    paths:
      - target/

copy-to-s3-job:
  stage: copy-to-s3
  dependencies:
    - integrationtest-job
  script:
    - echo "Logging into AWS..."
    - sh ./configure_aws.sh $ACCESS_KEY $SECRET_KEY $REGION
    - echo "Copying Jar file to S3..."
    - aws s3 cp target/$JAR_NAME s3://$S3_BUCKET/$JAR_NAME
  artifacts:
    paths:
      - target/

deploy-job:
  stage: deploy
  dependencies:
    - copy-to-s3-job
  script:
    - echo "Running deploy of the City API Application..."
    - aws elasticbeanstalk create-application-version --application-name city-api --version-label ${CI_COMMIT_SHA} --source-bundle S3Bucket=city-api-files,S3Key=$JAR_NAME
    - aws elasticbeanstalk update-environment --application-name city-api --environment-name Cityapi-env-1 --version-label ${CI_COMMIT_SHA}
  artifacts:
    paths:
      - target/*.jar